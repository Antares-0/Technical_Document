# Redis的集群与主从复制 & Redis集群分片

## 一、Redis集群（一种服务分片方式，通过一定的哈希算法，将数据分布在多个节点上）
1. Redis集群：一种水平扩展技术，解决单个Redis实例的内存和并发限制。它将数据分布在多个节点上，支持数据分区和自动故障转移。集群模式具有以下特点： 
   1. 数据分区：数据被分散在多个节点上，每个节点负责数据集的一部分，从而可以线性扩展存储容量和并发处理能力。
   2. 自动故障转移：集群中的节点可以自动检测其他节点的故障，并在必要时进行自动故障转移。
   3. 高可用性：集群中的多个节点可以同时提供服务，即使部分节点失败，集群仍然可以继续工作。
2. 简单来说，Redis集群就是将一个Redis进行拆分，得到的一个Redis组。

## 二、Redis主从复制（一种数据的复制方案，从主节点流向从节点）
1. 主从复制（Master-Slave Replication）是Redis提供的一种数据冗余和读写分离的技术。它通过将数据从主服务器（Master）复制到一个或多个从服务器（Slave）来实现： 
   1. 数据冗余：保证数据的持久性和防止数据丢失。 
   2. 读写分离：主服务器负责写操作，从服务器可以处理读请求，从而分担主服务器的读负载。 
   3. 简单的故障恢复：当主服务器故障时，可以手动将其中一个从服务器提升为主服务器，以恢复服务。 
   4. 一种常用的优化手段：将一个Redis服务器作为主节点（master），负责写操作；其他的Redis服务器作为从节点作为从节点（slave），负责读操作。主节点和从节点的关系是一对多，数据只能从主节点单项复制到从节点。
2. 简单来说，Redis主从复制的本质是多个Redis的copy

## 三、Redis集群与主从复制的关系（搭配使用）
1. 虽然主从复制和集群在概念上是独立的，但在实际部署中，它们经常被一起使用，以构建高度可扩展和容错的Redis环境： 
   1. 集群中的主从复制：在集群模式下，每个主节点都可以有从节点，形成主从复制关系。这样，即使某个主节点发生故障，从节点可以迅速接管，减少故障恢复时间。
   2. 集群与哨兵结合：哨兵不仅可以监控和管理非集群模式下的主从复制，也可以与集群模式下的主节点配合，实现更高级别的故障检测和自动恢复。
2. 总的来说，主从复制侧重于单个实例的数据冗余和读写分离，而集群则侧重于整个系统级别的数据分布和高可用性。两者结合使用，可以构建一个既具有高可用性又具备良好扩展性的Redis部署方案。

## 四、Redis分片
1. 分片方案：基础的分片方案有范围分片和哈希分片方案：
   1. 范围分片方案：userId从0-1000的由机器A维护，1001-2000的由机器B维护。这种方案虽然可行，但是需要维护一个映射表，实际上效率很低。
   2. 哈希分片方案（Redis采用）：通过一个Hash函数，将key的名称转换为一个数字，然后取余数做映射，找到对应的机器。
2. 分片的实现：
   1. 客户端分片：客户端自己计算需要寻找的Redis服务器节点位置
      1. 优点：降低了Redis侧集群的实现复杂度，因为具体的分片逻辑由客户端自己实现
      2. 缺点：客户端需要预先知道Redis的集群实例信息，新增Redis实例需要重启。
   2. 代理分片：将客户端的请求打到代理上，由代理进行分配
      1. 优点：降低了客户端的复杂度
      2. 缺点：多了一个分发的环节，会影响性能。
   3. 服务器分片：每个服务器上都有计算分片的逻辑，当接收到请求后转发给对应的处理节点
      1. 优点：支持高可用，任意一台挂了都可以有其他的机器对应处理。
      2. 缺点：需要客户端语言实现服务器集群协议。
3. 一致性哈希算法
   1. 使用hash环作为数据的基础“索引”
   2. 使用hash函数帮助定位具体的位置
   3. 解决不平衡的节点可以使用虚拟节点来平衡，并维护一个虚拟节点对真实节点的映射
   4. 一致性hash算法的应用场景：
      1. 分布式缓存
      2. 分布式数据库
      3. 负载均衡策略
      4. 分布式文件系统
4. 为什么采用一致性哈希：当节点动态变化的时候，更方便了。

   | 特性|	普通哈希（Hashing）	|一致性哈希（Consistent Hashing）|
   | --- | ---- | ---|
   |数据分布|	固定的哈希空间，数据均匀分布|	哈希环上的分布，数据靠近其节点|
   |扩展性|	扩展或减少节点需要重新分配大量数据|	扩展或减少节点只影响部分数据|
   |容错性	|宕机时没有自动恢复机制|	宕机时数据可由其他节点接管|
   |适用场景	|固定数量的节点或存储单元	|动态扩展的分布式系统，负载均衡|


参考资料：
1. Redis主从复制：https://blog.csdn.net/m0_59704905/article/details/139805983
2. Redis分片：https://blog.csdn.net/maizixuetang/article/details/140714488
3. 一致性Hash算法：https://blog.csdn.net/qq_37967783/article/details/131125046