# 浏览器浏览网页的背后发生了什么

当你在浏览器输入 `www.baidu.com` 并按下回车时，背后涉及复杂的计算机网络协议和分层协作。以下是详细的技术流程，按时间顺序展开：

---

## **1. URL 解析与缓存检查**
- **输入预处理**：浏览器解析 `www.baidu.com`，自动补全协议（HTTP/HTTPS）。若未指定，默认尝试 HTTPS（受 HSTS 策略影响）。
- **缓存查询**：
    - **浏览器缓存**：检查本地是否缓存过该页面的 DNS 记录或资源（如强缓存 `Cache-Control: max-age`）。
    - **操作系统缓存**：若浏览器无记录，查询系统 hosts 文件及 DNS 缓存（如 Windows 的 DNS Client 服务）。

---

## **2. DNS 解析（应用层）**
- **递归查询过程**：
    1. **本地 DNS 服务器**：向 ISP 提供的 DNS 服务器发起请求。
    2. **根域名服务器**：若本地无缓存，根服务器返回 `.com` 顶级域名服务器地址。
    3. **顶级域名服务器**：返回 `baidu.com` 的权威域名服务器地址。
    4. **权威域名服务器**：返回 `www.baidu.com` 的 A/AAAA 记录（IPv4/IPv6）。
- **优化机制**：
    - **DNS 负载均衡**：可能返回多个 IP（如 CDN 边缘节点），基于地理位置或延迟选择最优 IP。
    - **DNS 预取**：浏览器可能提前解析页面中的链接域名。

---

## **3. 建立 TCP 连接（传输层）**
- **三次握手**：
    1. **SYN**：客户端发送 SYN=1、随机序列号 `seq=x`。
    2. **SYN-ACK**：服务器返回 SYN=1、ACK=1，`seq=y`、`ack=x+1`。
    3. **ACK**：客户端发送 ACK=1，`seq=x+1`、`ack=y+1`。
- **端口与协议**：目标端口 443（HTTPS），源端口随机（如 50000）。
- **内核协议栈处理**：TCP 报文经操作系统协议栈封装，通过 Socket API 传递。

---

## **4. TLS 握手（安全层，HTTPS 场景）**
- **密钥协商**：
    1. **Client Hello**：发送支持的 TLS 版本、加密套件、随机数。
    2. **Server Hello**：选择加密套件（如 ECDHE-RSA-AES256-GCM-SHA384），返回证书和随机数。
    3. **证书验证**：浏览器验证证书链（根 CA → 中间 CA → 服务器证书），检查吊销状态（OCSP/CRL）。
    4. **密钥交换**：客户端生成预主密钥，用服务器公钥加密传输，双方通过 ECDHE 计算会话密钥。
- **会话恢复**：若存在 Session ID 或 Session Ticket，可跳过完整握手（节省 RTT）。

---

## **5. HTTP 请求与响应（应用层）**
- **请求构造**：
    - **请求行**：`GET / HTTP/1.1`
    - **请求头**：`Host: www.baidu.com`、`User-Agent`、`Accept-Encoding: gzip` 等。
    - **Cookie**：附加 `Cookie` 头（如 BAIDUID 用于会话跟踪）。
- **服务器处理**：
    - **反向代理**：请求可能被 Nginx 转发到后端服务器集群。
    - **负载均衡**：根据算法（如轮询、一致性哈希）选择服务器。
    - **生成响应**：服务器返回 HTML、CSS、JS 及资源文件，状态码 200 OK。

---

## **6. 浏览器渲染（渲染引擎）**
- **解析与构建**：
    1. **DOM 树**：HTML 解析器逐行解析，遇到 `<script>` 可能阻塞（除非标记 `async/defer`）。
    2. **CSSOM 树**：解析 CSS 规则，处理层叠和继承关系。
    3. **渲染树**：合并 DOM 和 CSSOM，排除不可见节点（如 `<head>`）。
- **布局与绘制**：
    - **回流（Reflow）**：计算节点几何属性（尺寸、位置）。
    - **重绘（Repaint）**：填充像素（颜色、边框等）。
    - **合成（Compositing）**：GPU 加速图层合成（如 CSS `transform`）。

---

## **7. 连接终止**
- **四次挥手**：
    1. **FIN**：客户端发送 FIN 包（假设客户端先关闭）。
    2. **ACK**：服务器确认。
    3. **FIN**：服务器发送 FIN 包。
    4. **ACK**：客户端确认，进入 TIME_WAIT 状态（防止旧报文干扰）。
- **Keep-Alive**：若启用 HTTP/1.1 持久连接，TCP 连接可能复用后续请求。

---

## **关键优化技术**
1. **CDN 加速**：静态资源（如图片）从边缘节点加载。
2. **HTTP/2 多路复用**：单连接并行传输多个资源。
3. **资源预加载**：通过 `<link rel="preload">` 提前获取关键资源。
4. **缓存策略**：`ETag` 和 `Last-Modified` 实现协商缓存。

---

## **思考延伸**
- **网络分层模型**：此过程完美体现了 OSI 七层模型（应用层 HTTP → 传输层 TCP → 网络层 IP → 数据链路层 MAC）。
- **安全与性能权衡**：TLS 增加延迟但保障安全，通过 Session 恢复和 False Start 优化。
- **IPv6 影响**：若使用 IPv6，DNS 返回 AAAA 记录，TCP 连接在 IPv6 网络层封装。

整个过程在百毫秒内完成，依赖协议设计（如 TCP 拥塞控制）、硬件性能（如服务器吞吐量）和软件优化（如浏览器并行下载）。
