# 外呼系统架构设计&面试总结

## 一、外呼系统架构设计
1. 参考某互联网公司架构设计
   - web服务：用于管理内部号码、话术创建等
   - batch服务：支持重播功能，承接外部调用
   - core服务：外呼的主体服务
   - limit服务：限频服务
   - sip调度服务：号码调度
   - 算法相关服务：外部支持
2. web服务
   - web服务包含话术管理页面：负责创建新的话术，管理话术版本，配置意图识别
   - web服务包含音色配置页面：针对某一个话术配置音色（甜美女声、标准男声）
   - web服务包含任务管理页面：外呼具体依赖的是任务，任务上配置了限频规则、使用的话术、号码组等信息
   - web服务包含号码管理页面：负责号码的上下线
   - web服务包含黑名单白名单管理页面：黑名单可以拉黑、白名单用于测试内部用户的外呼
3. batch服务：
   - 负责重播：监听重播消息，触发重播
   - 请求分配：调度请求至core服务【待进一步深挖】
4. core服务：
   - 外呼初始化：合成语音、调度号码、加载话术图、风控校验
   - sip通信建立：向外部发送`sip invite`请求，等待建立连接，参考`DialingRobot/SIP.MD`
   - 双工通信通道建立
   - 从通信通道中取语音
   - 语音转文本
   - 文本过意图识别服务
   - 根据意图实现对话跳转
   - 通话记录等信息保存
   - 是否触发重播
5. limit服务：
   - 过白名单校验，命中直接通过
   - 过黑名单校验，命中直接释放
   - 过业务逻辑校验，3天内拨打1次等
6. sip调度服务：
   - 查询本任务下可用的外呼号码
   - 将所有外呼号码按照城市做分组
   - 计算距离被叫最近的城市（用经纬度坐标计算勾股定理，计算距离）
   - 根据距离进行排序，选择离用户最近的号码
   ```txt
   原因：基于人类的基本假设：人更倾向节省时间，一个北京的用户更可能接听从新疆打来的电话还是天津的电话？
   所以用距离做一个排序，优先选择最近的
   实现：用勾股定理和经纬度坐标计算距离，数据库中存热门城市的经纬度坐标（用Redis做了缓存，每日更新），没有的返回一个中位数
   ```
7. 算法相关服务
   - 语音转文本服务
   - 文本转语音服务
   - 意图识别服务


## 二、面试总结（自己的工作部分）
1. 离线外呼系统
   - 背景：通过上传excel的形式进行外呼，而不是通过之前的接口调用
   - 系统设计：先将上传的excel解析成对应的外呼记录落库，然后开启一个定时任务实现调度外呼
     - 批次表`batch`：每上传一个excel，对应的就是一个批次，批次里面包含状态，标识批次的外呼状态（没有外呼、外呼中、外呼完毕）
     - 批次详细表`batch_mapping`：excel中的记录被解析为具体的外呼信息（手机号、槽位信息）
   - 限流策略
     - 限流原因：web服务调用batch服务，需要限制流量，因为离线外呼的重要性不如在线为外呼，要控制离线外呼对batch的调用
     - 限流实现：在配置中心写了一个配置，代表定时任务每分钟从数据库中捞取的信息数量，实现对调用量的动态调整
   - 并发控制
     - 控制原因：线上多台服务器，每台服务器都会开启定时任务进行数据库的扫描，为了避免同一个批次被拨打两次，需要进行并发控制
     - 控制实现：使用基于Redis的Redisson分布式锁框架实现加锁，其中用tryLock实现逻辑
       - 为什么使用tryLock：
         - RedissonClient.lock方法：阻塞地获取，一直等到获取锁再返回
         - RedissonClient.tryLock方法：非阻塞地获取，获取失败直接返回false，tryLock同时支持可重入、加锁时间限制、等待时间限制
       - tryLock锁住的是批次信息，相当于是第一层锁，获取到了批次信息才能够去下一步外呼
       - tryLock的过期时间：设置为拨打条目总数除以拨打速度（也就是之前配置的代码）
   - 宕机容错：设计了先落库、再调度外呼的策略
     - 容错原因：如果机器挂了，需要从上一次外呼的地方自动恢复
     - 容错实现：先落库，再外呼；而不是一边解析excel一边外呼
   - 持久化：excel保存在分布式文件系统中，外呼记录先进入数据库
2. 老服务上云
   - 录音文件的迁移
     - 背景：有历史存在的录音文件，放在物理机上是没有问题直接访问就可以了
     - 解决方案：用了内部的组件WFS进行了实现
     - 底层原理：linux的远程文件挂载机制`Linux/Linux远程文件挂载机制.MD`
   - 版本冲突解决 + JDK升级至21
3. 大模型外呼
   - 大模型回复慢：流式语音 + 流式大模型回复
   - 音色突变问题：固定长度合成语音转变为按照语义分割，按照逗号、句号的形式进行分割
   - 传统AI外呼存在的问题：
     - 回复太死板：固定话术
   - 怎样提升AI回复的准确率：prompt工程 + RAG知识库 + FT大模型微调

## 三、设计相关
1. 外呼存在的问题之一：难以测试
   - 很难做真实的线上压力测试：不可能同时外呼100w条进行测试，成本和被叫都难以准备
     - 补偿措施：线程空转20s模拟
2. 外呼存在的问题之二：core服务的压力太大，负责的模块太多了，应当从整体架构的角度进行修复

## 四、待开发的外呼细节
1. 双呼的具体实现
2. 转人工的具体实现
3. 呼入的具体实现

## 五、外呼细节
1. 线上机器的数量：
   - 老服务：14台物理机 --> 云30台容器
   - 新服务：7台云容器
2. QPS：每日外呼时间集中在 9-12 & 14-18 之间
   - 新服务：理论外呼上限在150w左右，真实外呼过最高80w，日30-40w左右，qps在10-20左右
   - 老服务：每日均值在50w左右，密歇根相关业务在运行
3. 号码是向下游运营商的子公司等购买的虚拟号码
4. 号码绑定映射：业务线--渠道--话术--任务--号码组--号码


参考文档：
1. RedissonClient.tryLock和RedissonClient.lock：https://blog.csdn.net/qq_41029282/article/details/130250784

